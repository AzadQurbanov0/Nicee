<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Balans & Çək Görüntüləri</title>
<style>
  body{margin:0;padding:20px;font-family:system-ui,Segoe UI,Roboto,Arial;background:#0f1724;color:#e6eef8;}
  h1{margin:0 0 12px 0;text-align:center;}
  .container{max-width:1100px;margin:0 auto;}
  .section{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:12px;margin-bottom:16px;}
  table{width:100%;border-collapse:collapse;margin-top:8px;}
  th,td{padding:8px;border:1px solid rgba(255,255,255,0.06);text-align:center;font-size:14px; word-break: break-word;}
  th{background:rgba(255,255,255,0.03);}
  .controls button{padding:6px 10px;border-radius:6px;border:none;cursor:pointer;margin:2px;}
  .add{background:#16a34a;color:white;}
  .sub{background:#ef4444;color:white;}
  .apply{background:#2563eb;color:white;}
  input[type=number]{width:70px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071025;color:#e6eef8;}
  /* photos grid */
  .photos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px;}
  .photo-card{background:#071122;border:1px solid #122135;border-radius:8px;overflow:hidden;display:flex;flex-direction:column;}
  .photo-card img{width:100%;height:160px;object-fit:cover;background:#071122;}
  .photo-meta{padding:10px;font-size:13px;color:#dbeafe;}
  .small{opacity:0.75;font-size:12px;color:#9fb3d9;}
  .photo-actions{display:flex;gap:8px;margin-top:8px;}
  .link-btn{background:#0ea5e9;color:white;padding:6px;border-radius:6px;border:none;cursor:pointer;}
  .del-btn{background:#ef4444;color:white;padding:6px;border-radius:6px;border:none;cursor:pointer;}
  .complete-btn {background:#16a34a;color:white;padding:6px;border-radius:6px;border:none;cursor:pointer;}
  .no-data{opacity:0.7;text-align:center;padding:18px;color:#9fb3d9;}
</style>
</head>
<body>
  <div class="container">
    <h1>Admin Panel - Gizli</h1>

    <div class="section" id="withdrawalsSection">
      <h2 style="margin:0 0 8px 0;">Pul Çıxarma Sorğuları (Kart Məlumatları)</h2>
      <table id="withdrawalsTable" aria-label="Sorğular cədvəli">
        <thead>
          <tr><th>İstifadəçi Email</th><th>Ad</th><th>Soyad</th><th>Kart Nömrəsi</th><th>Tarix</th><th>Əməliyyat</th></tr>
        </thead>
        <tbody>
            <tr class="no-data-row"><td colspan="6" class="no-data">Heç bir sorğu yoxdur.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="section" id="balancesSection">
      <h2 style="margin:0 0 8px 0;">İstifadəçilər & Balans</h2>
      <table id="userTable" aria-label="İstifadəçilər cədvəli">
        <thead>
          <tr><th>Ad</th><th>Email</th><th>Balans (AZN)</th><th>Əməliyyat</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section" id="photosSection">
      <h2 style="margin:0 0 8px 0;">Göndərilən Şəkillər (Çeklər)</h2>
      <div id="photosContainer" class="photos-grid">
        <div class="no-data" id="noPhotos">Heç bir şəkil yoxdur.</div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC4sGTK_P4KperVswrxxmt69H5cocsgnNw",
      authDomain: "niceuc-e5986.firebaseapp.com",
      databaseURL: "https://niceuc-e5986-default-rtdb.firebaseio.com",
      projectId: "niceuc-e5986",
      storageBucket: "niceuc-e5986.firebasestorage.app",
      messagingSenderId: "242221260650",
      appId: "1:242221260650:web:d140153a2167c4738dcf13",
      measurementId: "G-YKKRHJKYNB"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();
    
    function tsFormat(ms){
      if(!ms) return '';
      return new Date(ms).toLocaleString();
    }
    function escapeHtml(s){
      return String(s || '').replace(/[&<>"'`]/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#x60;'})[c]);
    }
    
    const withdrawalsTableBody = document.getElementById('withdrawalsTable').querySelector('tbody');
    const withdrawalsRef = db.ref('withdrawals');

    withdrawalsRef.on('child_added', snap => {
        const key = snap.key;
        const data = snap.val();
        renderWithdrawalRow(key, data);
    });

    withdrawalsRef.on('child_removed', snap => {
        const row = document.getElementById('req-'+snap.key);
        if(row) row.remove();
        if(withdrawalsTableBody.children.length === 1 && withdrawalsTableBody.querySelector('.no-data-row')){
             withdrawalsTableBody.querySelector('.no-data-row').style.display = 'table-row';
        }
    });

    function renderWithdrawalRow(key, data){
        const noDataRow = withdrawalsTableBody.querySelector('.no-data-row');
        if (noDataRow) noDataRow.style.display = 'none';

        const tr = document.createElement('tr');
        tr.id = 'req-' + key;
        tr.innerHTML = `
            <td>${escapeHtml(data.userEmail)}</td>
            <td>${escapeHtml(data.requestData.name)}</td>
            <td>${escapeHtml(data.requestData.surname)}</td>
            <td><strong>${escapeHtml(data.requestData.cardNumber)}</strong></td>
            <td>${tsFormat(data.createdAt)}</td>
            <td>
                <button class="complete-btn" onclick="processWithdrawal('${key}')">Tamamlandı</button>
            </td>
        `;
        withdrawalsTableBody.prepend(tr);
    }
    
    function processWithdrawal(key){
        if(!confirm('Bu sorğunu yerinə yetirdiniz və siyahıdan silmək istəyirsiniz?')) return;
        db.ref('withdrawals/' + key).remove()
            .then(()=> console.log(`Sorğu ${key} silindi.`))
            .catch(err => alert('Silərkən xəta baş verdi: ' + err.message));
    }

    const userTableBody = document.getElementById('userTable').querySelector('tbody');
    const userRows = {};

    function loadUsers(){
      db.ref('users').get().then(snapshot => {
        snapshot.forEach(child => {
          const uid = child.key;
          const data = child.val();
          db.ref('balances/' + uid).get().then(bsnap=>{
            const balance = bsnap.val() || 0;
            if(!userRows[uid]){
              const tr = document.createElement('tr');
              tr.id = 'row-'+uid;
              tr.innerHTML = `
                <td>${escapeHtml(data.name || '')}</td>
                <td>${escapeHtml(data.email || '')}</td>
                <td id="bal-${uid}">${parseFloat(balance).toFixed(2)}</td>
                <td>
                  <button class="add" onclick="adjustBalance('${uid}',1)">+1</button>
                  <button class="sub" onclick="adjustBalance('${uid}',-1)">-1</button><br>
                  <input type="number" id="input-${uid}" value="0">
                  <button class="apply" onclick="changeBalance('${uid}')">Tətbiq et</button>
                </td>
              `;
              userTableBody.appendChild(tr);
              userRows[uid] = tr;
            } else {
              const balTd = document.getElementById('bal-'+uid);
              if(balTd) balTd.textContent = parseFloat(balance).toFixed(2);
            }
          });
        });
      });
    }

    function adjustBalance(uid,amount){
      db.ref('balances/'+uid).transaction(current => (current||0) + amount);
    }

    function changeBalance(uid){
      const input = document.getElementById('input-'+uid);
      const val = parseFloat(input.value);
      if(isNaN(val)) return;
      db.ref('balances/'+uid).transaction(current => (current||0) + val);
      input.value = 0;
    }
    loadUsers();
    setInterval(loadUsers, 5000);

    const photosContainer = document.getElementById('photosContainer');
    const noPhotosEl = document.getElementById('noPhotos');
    const photosRef = db.ref('photos');

    photosRef.limitToLast(500).on('child_added', snap => renderPhotoCard(snap.key, snap.val()));
    photosRef.on('child_removed', snap => removePhotoCard(snap.key));

    function renderPhotoCard(key, data){
      if(!data || !data.url) return;
      noPhotosEl.style.display = 'none';
      const card = document.createElement('div');
      card.className = 'photo-card';
      card.id = 'photo-'+key;
      card.innerHTML = `
        <img src="${escapeHtml(data.url)}" alt="çek" loading="lazy" onerror="this.src=''">
        <div class="photo-meta">
          <div><strong>${escapeHtml(data.name || 'İstifadəçi')}</strong></div>
          <div class="small">${escapeHtml(data.email || '')}</div>
          <div class="small">${tsFormat(data.createdAt)}</div>
          <div class="photo-actions">
            <button class="link-btn" onclick="window.open('${escapeHtml(data.url)}', '_blank')">Şəkli aç</button>
            <button class="del-btn" id="del-${key}">Sil</button>
          </div>
        </div>
      `;
      photosContainer.prepend(card);
      document.getElementById('del-'+key).addEventListener('click', async ()=>{
        if(!confirm('Bu şəkili silmək istəyirsən?')) return;
        try{
          await db.ref('photos/' + key).remove();
          if(data.storagePath) await storage.ref(data.storagePath).delete().catch(()=>{});
        } catch(err){ alert('Silərkən xəta: ' + err.message); }
      });
    }
    
    function removePhotoCard(key){
      const el = document.getElementById('photo-' + key);
      if(el) el.remove();
      if(!photosContainer.querySelector('.photo-card')) noPhotosEl.style.display = 'block';
    }
  </script>
</body>
</html>
