<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel</title>
<style>
  :root { --bg-main: #0f1724; --bg-section: #0b1220; --border-color: #1f2937; --text-main: #e6eef8; --text-muted: #9fb3d9; --green: #16a34a; --red: #dc2626; --blue: #2563eb; --yellow: #f59e0b; --purple: #4f46e5; }
  body{margin:0;padding:20px;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg-main);color:var(--text-main); display: flex; align-items: center; justify-content: center; min-height: 100vh;}
  .container{max-width:1300px;margin:0 auto; width: 100%;}
  h1,h2{margin:0 0 12px 0; text-align: center;}
  .section{background:var(--bg-section);border:1px solid var(--border-color);border-radius:10px;padding:12px;margin-bottom:16px;}
  table{width:100%;border-collapse:collapse;margin-top:8px;}
  th,td{padding:8px 10px;border:1px solid rgba(255,255,255,0.06);text-align:center;font-size:14px; word-break: break-word; vertical-align: middle;}
  th{background:rgba(255,255,255,0.03);}
  .no-data{opacity:0.7;text-align:center;padding:18px;color:var(--text-muted);}
  #login-container { text-align: center; padding-top: 20vh;}
  #adminLoginBtn { background: #4285F4; color: white; border: none; padding: 12px 24px; font-size: 1.1rem; border-radius: 8px; cursor: pointer; font-weight: 600; }
  .btn { padding: 5px 10px; border-radius: 6px; border: none; cursor: pointer; color: white; font-size: 0.8rem; margin: 2px; }
  .btn-green { background: var(--green); } .btn-red { background: var(--red); } .btn-blue { background: var(--blue); } .btn-dark-red { background: #991b1b; }
  .status { font-weight: bold; padding: 4px 8px; border-radius: 6px; color: white; }
  .status-pending { background-color: var(--yellow); } .status-approved { background-color: var(--green); } .status-rejected { background-color: var(--red); }
  .actions-cell { display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap; }
  .balance-input { width: 80px; padding: 4px; border-radius: 4px; border: 1px solid #334155; background: #1e293b; color: var(--text-main); }
  
  /* === DƏSTƏK MƏRKƏZİ STİLLƏRİ === */
  #support-center { display: flex; gap: 16px; min-height: 60vh; max-height: 70vh; }
  #chat-list-container { flex: 0 0 300px; background: rgba(0,0,0,0.1); border-radius: 8px; overflow-y: auto; padding: 8px; }
  .chat-list-item { padding: 12px; border-radius: 6px; cursor: pointer; margin-bottom: 6px; border: 1px solid transparent; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; }
  .chat-list-item:hover { background: rgba(255,255,255,0.05); border-color: var(--border-color); }
  .chat-list-item.active { background: var(--blue); color: white; }
  .new-message-indicator { width: 10px; height: 10px; background-color: var(--green); border-radius: 50%; }
  #chat-view-container { flex-grow: 1; border-radius: 8px; background: rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
  #chat-view-header { padding: 12px; background: rgba(0,0,0,0.2); font-weight: bold; text-align: center; border-bottom: 1px solid var(--border-color); }
  #messages-container { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
  .message { max-width: 70%; padding: 8px 12px; border-radius: 10px; line-height: 1.4; word-break: break-word; }
  .message.user { background: #374151; color: white; align-self: flex-start; }
  .message.admin { background: var(--purple); color: white; align-self: flex-end; }
  #reply-area { display: flex; padding: 10px; border-top: 1px solid var(--border-color); }
  #reply-input { flex-grow: 1; background: #1e293b; border: 1px solid #334155; border-radius: 6px; padding: 8px; color: white; }
  #send-reply-btn { background: var(--purple); color: white; border: none; padding: 0 16px; border-radius: 6px; margin-left: 8px; cursor: pointer; font-weight: bold; }
  #chat-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); }

  /* MOBİL STİLLƏRİ */
  @media screen and (max-width: 768px) {
    body { padding: 10px; }
    #support-center { flex-direction: column; height: auto; max-height: none; }
    #chat-list-container { flex-basis: 200px; }
    table, thead, tbody, th, td, tr { display: block; }
    thead tr { position: absolute; top: -9999px; left: -9999px; }
    tr { margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    td { border: none; border-bottom: 1px solid rgba(255,255,255,0.06); position: relative; padding-left: 50%; text-align: right; min-height: 30px; display: flex; align-items: center; justify-content: flex-end; }
    td:last-child { border-bottom: 0; }
    td:before { content: attr(data-label); position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; opacity: 0.8; }
    .actions-cell { flex-direction: column; align-items: stretch; padding: 10px; gap: 8px; }
    .balance-input, .btn { width: 100%; box-sizing: border-box; padding: 8px; margin: 0; }
  }
</style>
</head>
<body>
<div class="container">
    <div id="login-container"><h1>Admin Panel</h1><button id="adminLoginBtn">Google ilə Daxil Ol</button></div>
    <div id="main-content" style="display: none;">
      <h1 id="admin-welcome"></h1>
      
      <div class="section">
        <h2 style="margin:0;">Dəstək Mərkəzi</h2>
        <div id="support-center">
            <div id="chat-list-container"></div>
            <div id="chat-view-container">
                <div id="chat-placeholder">Söhbətə baxmaq üçün siyahıdan bir istifadəçi seçin</div>
                <div id="chat-view" style="display:none; height:100%; flex-direction:column; display:flex;">
                    <div id="chat-view-header"></div>
                    <div id="messages-container"></div>
                    <div id="reply-area">
                        <input type="text" id="reply-input" placeholder="Cavabınızı yazın...">
                        <button id="send-reply-btn">Göndər</button>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <div class="section">
        <h2 style="margin:0;">Pul Çıxarma Sorğuları</h2>
        <table id="withdrawalsTable">
            <thead><tr><th>Email</th><th>Ad/Soyad</th><th>Kart</th><th>Məbləğ</th><th>Tarix</th><th>Status</th><th>Əməliyyat</th></tr></thead>
            <tbody><tr class="no-data-row"><td colspan="7" class="no-data">Heç bir sorğu yoxdur.</td></tr></tbody>
        </table>
      </div>

      <div class="section">
          <h2 style="margin:0;">İstifadəçilər & Balans</h2>
          <table id="userTable">
              <thead><tr><th>Ad</th><th>Email</th><th>Balans (AZN)</th><th>Əməliyyatlar</th></tr></thead>
                <tbody><tr class="no-data-row"><td colspan="4" class="no-data">İstifadəçi yoxdur.</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyC4sGTK_P4KperVswrxxmt69H5cocsgnNw", authDomain: "niceuc-e5986.firebaseapp.com", databaseURL: "https://niceuc-e5986-default-rtdb.firebaseio.com", projectId: "niceuc-e5986", appId: "1:242221260650:web:d140153a2167c4738dcf13" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentChatUid = null;
    let messagesListener = null;

    auth.onAuthStateChanged(user => {
        const mainContent = document.getElementById('main-content');
        if (user) {
            mainContent.style.display = 'block';
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('admin-welcome').textContent = `Xoş gəldiniz, ${user.displayName}`;
            loadAllData();
        } else {
            mainContent.style.display = 'none';
            document.getElementById('login-container').style.display = 'block';
        }
    });
    document.getElementById('adminLoginBtn').addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));
    
    function loadAllData() {
        loadSupportChats();
        loadWithdrawals();
        loadUsersAndBalances();
    }

    function loadSupportChats() {
        const chatListContainer = document.getElementById('chat-list-container');
        const chatRef = db.ref('support_chats').orderByChild('last_updated');
        chatRef.on('value', snapshot => {
            chatListContainer.innerHTML = '';
            if (!snapshot.exists()) {
                chatListContainer.innerHTML = '<p class="no-data">Heç bir söhbət yoxdur.</p>';
                return;
            }
            let chats = [];
            snapshot.forEach(child => {
                chats.push({ uid: child.key, ...child.val() });
            });
            chats.reverse();

            chats.forEach(chatData => {
                const item = document.createElement('div');
                item.className = 'chat-list-item';
                if (chatData.uid === currentChatUid) {
                    item.classList.add('active');
                }
                item.innerHTML = `<span>${chatData.user_email || 'Naməlum'}</span> ${chatData.new_message_for_admin ? '<div class="new-message-indicator"></div>' : ''}`;
                item.onclick = () => openChat(chatData.uid, chatData.user_email);
                chatListContainer.appendChild(item);
            });
        });

        document.getElementById('send-reply-btn').onclick = sendAdminReply;
        document.getElementById('reply-input').onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAdminReply();
            }
        };
    }

    function openChat(uid, userEmail) {
        currentChatUid = uid;
        document.querySelectorAll('.chat-list-item').forEach(el => el.classList.remove('active'));
        const activeItem = [...document.querySelectorAll('.chat-list-item')].find(el => el.textContent.includes(userEmail));
        if (activeItem) activeItem.classList.add('active');

        document.getElementById('chat-placeholder').style.display = 'none';
        document.getElementById('chat-view').style.display = 'flex';
        document.getElementById('chat-view-header').textContent = `Söhbət: ${userEmail}`;
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.innerHTML = '';

        if (messagesListener) {
            messagesListener.off();
        }

        db.ref(`support_chats/${uid}`).update({ new_message_for_admin: false });

        const messagesRef = db.ref(`support_chats/${uid}/messages`).limitToLast(100);
        messagesListener = messagesRef.on('child_added', msgSnapshot => {
            const msg = msgSnapshot.val();
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${msg.sender === 'admin' ? 'admin' : 'user'}`;
            msgDiv.textContent = msg.text;
            messagesContainer.appendChild(msgDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
    }

    function sendAdminReply() {
        const input = document.getElementById('reply-input');
        const text = input.value.trim();
        if (text === '' || !currentChatUid) return;

        const messageData = { text: text, sender: 'admin', timestamp: firebase.database.ServerValue.TIMESTAMP };
        db.ref(`support_chats/${currentChatUid}/messages`).push(messageData);

        db.ref(`support_chats/${currentChatUid}`).update({
            last_message: text,
            last_updated: firebase.database.ServerValue.TIMESTAMP,
            new_message_for_admin: false,
            new_message_for_user_count: firebase.database.ServerValue.increment(1)
        });

        input.value = '';
    }
    
    function updateRequestStatus(key, newStatus) { if(confirm(`Statusu '${newStatus}' olaraq dəyiş?`)) db.ref('withdrawals/' + key).update({ status: newStatus }); }
    function deleteRequest(key, msg) { if(confirm(msg || "Sorğunu silmək istəyirsiniz?")) db.ref('withdrawals/' + key).remove(); }
    function deleteUser(uid, email) { if(confirm(`'${email}' istifadəçisini sil? Bu əməliyyat geri qaytarılmazdır.`)) { db.ref('users/' + uid).remove(); db.ref('balances/' + uid).remove(); }}
    
    async function applyBalanceChange(uid) {
        const inputElement = document.getElementById(`balance-input-${uid}`);
        const inputValue = inputElement.value.trim();
        if (inputValue === '') { return alert("Zəhmət olmasa, bir dəyər daxil edin."); }
        try {
            const balanceSnapshot = await db.ref('balances/' + uid).once('value');
            let currentBalance = balanceSnapshot.exists() && balanceSnapshot.val().amount ? parseFloat(balanceSnapshot.val().amount) : 0;
            if (isNaN(currentBalance)) currentBalance = 0;
            
            const changeValue = parseFloat(inputValue.replace(',', '.'));
            if (isNaN(changeValue)) { return alert("Zəhmət olmasa, düzgün rəqəm daxil edin (məsələn: 50, +50, -20)."); }

            let newBalance = (inputValue.startsWith('+') || inputValue.startsWith('-')) ? currentBalance + changeValue : changeValue;
            if (newBalance < 0) newBalance = 0;

            if (confirm(`İstifadəçinin balansını ${newBalance.toFixed(2)} AZN olaraq təyin etmək istəyirsiniz?`)) {
                await db.ref('balances/' + uid).set({ amount: newBalance });
                alert("Balans uğurla yeniləndi!");
                inputElement.value = '';
            }
        } catch (error) {
            alert("Balans yenilənərkən xəta baş verdi: " + error.message);
        }
    }
    
    // === DƏYİŞİKLİK BU FUNKSİYADADIR ===
    function loadWithdrawals() {
        const withdrawalsTableBody = document.getElementById('withdrawalsTable').querySelector('tbody');
        db.ref('withdrawals').on('value', (snapshot) => {
            if (!snapshot.exists()) {
                withdrawalsTableBody.innerHTML = '<tr class="no-data-row"><td colspan="7" class="no-data">Heç bir sorğu yoxdur.</td></tr>';
                return;
            }
            withdrawalsTableBody.innerHTML = '';
            let requests = [];
            snapshot.forEach(child => {
                requests.push({ key: child.key, ...child.val() });
            });

            // === YENİ SIRALAMA MƏNTİQİ ===
            requests.sort((a, b) => {
                const a_is_pending = a.status === 'pending';
                const b_is_pending = b.status === 'pending';

                if (a_is_pending && !b_is_pending) return -1; // "a" ("pending") yuxarıda olsun
                if (!a_is_pending && b_is_pending) return 1;  // "b" ("pending") yuxarıda olsun

                // Əgər hər ikisi "pending"dirsə və ya heç biri deyilsə, tarixə görə sırala
                return b.createdAt - a.createdAt; // Ən yeni olan yuxarıda
            });
            // === SIRALAMA SONU ===

            requests.forEach(data => {
                const reqData = data.requestData;
                const tr = document.createElement('tr');
                let statusText, statusClass;
                switch (data.status) {
                    case 'approved': statusText = 'Onaylandı'; statusClass = 'status-approved'; break;
                    case 'rejected': statusText = 'Rədd edildi'; statusClass = 'status-rejected'; break;
                    default: statusText = 'Gözləmədə'; statusClass = 'status-pending';
                }
                let actionButtons;
                if (data.status === 'pending') {
                    actionButtons = `<button class="btn btn-green" onclick="updateRequestStatus('${data.key}', 'approved')">Onayla</button><button class="btn btn-red" onclick="updateRequestStatus('${data.key}', 'rejected')">Rədd et</button>`;
                } else {
                    actionButtons = `<button class="btn btn-dark-red" onclick="deleteRequest('${data.key}', 'Bu sorğunu silmək istədiyinizə əminsiniz?')">Sil</button>`;
                }
                tr.innerHTML = `<td data-label="Email">${data.userEmail}</td><td data-label="Ad/Soyad">${reqData.name} ${reqData.surname}</td><td data-label="Kart">${reqData.cardNumber}</td><td data-label="Məbləğ"><b>${parseFloat(reqData.amount).toFixed(2)} AZN</b></td><td data-label="Tarix">${new Date(data.createdAt).toLocaleString()}</td><td data-label="Status"><span class="status ${statusClass}">${statusText}</span></td><td data-label="Əməliyyat"><div class="actions-cell">${actionButtons}</div></td>`;
                withdrawalsTableBody.appendChild(tr);
            });
        });
    }

    function loadUsersAndBalances() {
        const userTableBody = document.getElementById('userTable').querySelector('tbody');
        db.ref('users').on('value', (userSnapshot) => {
            db.ref('balances').on('value', (balanceSnapshot) => {
                if (!userSnapshot.exists()) {
                    userTableBody.innerHTML = '<tr class="no-data-row"><td colspan="4" class="no-data">İstifadəçi yoxdur.</td></tr>';
                    return;
                }
                userTableBody.innerHTML = '';
                const allBalances = balanceSnapshot.val() || {};
                userSnapshot.forEach(childSnapshot => {
                    const uid = childSnapshot.key;
                    const userData = childSnapshot.val();
                    const userBalance = allBalances[uid] && allBalances[uid].amount ? allBalances[uid].amount : 0;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td data-label="Ad">${userData.displayName || 'Adsız'}</td><td data-label="Email">${userData.email}</td><td data-label="Balans (AZN)"><b>${parseFloat(userBalance).toFixed(2)} AZN</b></td><td data-label="Əməliyyatlar"><div class="actions-cell"><input type="text" id="balance-input-${uid}" placeholder="+50, -20, 200" class="balance-input"><button class="btn btn-blue" onclick="applyBalanceChange('${uid}')">Tətbiq et</button><button class="btn btn-dark-red" onclick="deleteUser('${uid}', '${userData.email}')">Sil</button></div></td>`;
                    userTableBody.appendChild(tr);
                });
            });
        });
    }
</script>
</body>
</html>
