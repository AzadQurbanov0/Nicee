<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Para Ã‡uvalÄ±</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="preloader"></div>
<div id="animated-bag">ğŸ’°</div>

<div class="content-wrapper">
    <div id="notification-bell"><span>ğŸ””</span><div id="notification-badge" style="display:none;">1</div></div>
    <div class="wrap">
        <div id="userInfo" class="user-info"></div>
        <div class="card">
            <div class="bag">ğŸ’°</div>
            <div class="balance">
                <span class="symbol">AZN</span><span id="balance" class="value">0.00</span>
            </div>
        </div>
        <button class="google-btn" id="loginBtn">ğŸŒ GiriÅŸ</button>
    </div>
    <div class="action-buttons">
        <button id="payBtn">ğŸ’² YÃœKLÆ</button>
        <button id="cekBtn">ğŸ“· Ã‡EK</button>
        <button id="pulCekBtn">ğŸ¦ Ã‡EK</button>
    </div>
    <div class="modalOverlay" id="payModal"><div class="modalContent"><p>ğŸ’² PUL YÃœKLÆ M10 077 543 50 53</p><button class="close-modal-btn">BaÄŸla</button></div></div>
    <div class="modalOverlay" id="cekModal"><div class="modalContent"><p>Ã‡ÆKÄ°N ÅÆKLÄ°NÄ° GÃ–NDÆRMÆYÆ BAS</p><button id="sendCekBtn">GÃ–NDÆR</button><button class="close-modal-btn">BaÄŸla</button></div></div>
    <div class="modalOverlay" id="pulCekModal"><div class="modalContent"><h3>Pul Ã‡Ä±xarma SorÄŸusu</h3><input type="number" id="withdrawAmount" placeholder="MÉ™blÉ™ÄŸ (AZN)" required><input type="text" id="userName" placeholder="Ad" required><input type="text" id="userSurname" placeholder="Soyad" required><input type="tel" id="cardNumber" placeholder="Kart nÃ¶mrÉ™si (16 rÉ™qÉ™m)" maxlength="16" required><button id="withdrawBtn">ğŸ’¸ PUL Ã‡IXART</button><button class="close-modal-btn">BaÄŸla</button></div></div>
    <div class="modalOverlay" id="notificationsModal"><div class="modalContent"><h3>ÆmÉ™liyyat TarixÃ§É™si</h3><div id="notifications-list"></div><button class="close-modal-btn">BaÄŸla</button></div></div>
    <div id="support-widget"><div id="chat-window"><div id="chat-header">DÉ™stÉ™k</div><div id="chat-messages"></div><div id="chat-input-area"><input type="text" id="chat-input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..."><button id="send-chat-btn"> gÃ¶ndÉ™r</button></div></div><button id="chat-toggle-btn"><span>ğŸ’¬</span><div id="chat-notification-badge" style="display:none;"></div></button></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script src="script.js"></script>
</body>
</html>
:root{
  --bg1:#0f0c29; --bg2:#302b63; --bg3:#24243e; --card:rgba(255,255,255,0.06);
  --glass:rgba(255,255,255,0.12); --text:#f8fafc; --accent:#22c55e;
}
*{box-sizing:border-box;margin:0;padding:0;}
html{height:100%;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji';
  color:var(--text); background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  display: flex; align-items: center; justify-content: center;
  min-height: 100vh; overflow:hidden;
}
.wrap{display:grid;place-items:center;gap:12px;text-align:center;padding:20px;}
.user-info{font-size:1rem;font-weight:600;opacity:.9;margin-bottom:6px;}
.card{
  position:relative; width:min(60vw,320px); aspect-ratio:1/1; display:grid; place-items:center;
  background: radial-gradient(60% 60% at 50% 30%,var(--glass),transparent 70%),var(--card);
  border:1px solid rgba(255,255,255,0.14); border-radius:24px;
  box-shadow:0 15px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.08);
  backdrop-filter:blur(6px);
}
.bag{font-size:clamp(5rem,18vw,12rem);filter:drop-shadow(0 8px 15px rgba(0,0,0,0.35));user-select:none;animation:float 5s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
.balance{margin-top:10px;display:grid;place-items:center;font-weight:700;letter-spacing:1px;text-shadow:0 2px 5px rgba(0,0,0,0.5);}
.balance .symbol{font-size:clamp(1rem,2.5vw,1.5rem);opacity:.9;margin-right:4px;}
.balance .value{font-size:clamp(1.5rem,5vw,2.5rem);line-height:1;}
.google-btn{ margin-top:14px; padding:8px 16px; font-size:0.95rem; background:#4285F4; color:white; border:none; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:600;}
.action-buttons button { position: fixed; right: 20px; padding: 8px 14px; font-size: 0.9rem; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
#payBtn { top: 20px; background: #22c55e; }
#cekBtn { top: 58px; background: #2563eb; }
#pulCekBtn { top: 96px; background: #f59e0b; }
#notification-bell { position: fixed; top: 20px; left: 20px; font-size: 28px; cursor: pointer; user-select: none; z-index: 10000; }
#notification-badge { position: absolute; top: -5px; right: -8px; background: #ef4444; color: white; width: 20px; height: 20px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
.modalOverlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:9999; display:none; }
.modalContent{ background:linear-gradient(135deg,var(--bg1),var(--bg2)); padding:20px; border-radius:12px; text-align:center; color:white; width: min(90vw, 350px); }
.modalContent input { display: block; width: 95%; margin: 10px auto; padding: 10px; border-radius: 5px; border: 1px solid rgba(255, 255, 255, 0.2); background: #FFFFFF; color: #212529; font-size: 1rem; }
.modalContent button { margin-top:12px; padding:8px 16px; font-size:1rem; border:none; border-radius:8px; cursor:pointer; }
#notifications-list { max-height: 400px; overflow-y: auto; text-align: left; margin-top: 15px; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 8px; }
.notification-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9rem; border-left: 4px solid #555; }
.notification-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.notification-item-amount { font-size: 1.1rem; font-weight: bold; }
.notification-item-status { font-weight: bold; padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.8rem;}
.notification-item-body { font-size: 0.85rem; opacity: 0.8; }
.notification-item-footer { font-size: 0.75rem; opacity: 0.7; margin-top: 8px; text-align: right; }
.status-pending { border-left-color: #f59e0b; } .status-pending .notification-item-status { background-color: #f59e0b; }
.status-approved { border-left-color: #16a34a; } .status-approved .notification-item-status { background-color: #16a34a; }
.status-rejected { border-left-color: #dc2626; } .status-rejected .notification-item-status { background-color: #dc2626; }
#support-widget { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
#chat-toggle-btn { background: #0ea5e9; color: white; width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); position: relative; }
#chat-notification-badge { position: absolute; top: 0px; right: 0px; background: #ef4444; color: white; min-width: 22px; height: 22px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; padding: 2px; }
#chat-window { position: absolute; bottom: 80px; right: 0; width: 320px; max-width: 90vw; height: 400px; background: var(--bg3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; display: none; flex-direction: column; overflow: hidden; }
#chat-header { padding: 10px; background: rgba(0,0,0,0.2); font-weight: bold; text-align: center; }
#chat-messages { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
.message { max-width: 80%; padding: 8px 12px; border-radius: 10px; line-height: 1.4; word-break: break-word; }
.message.user { background: #2563eb; color: white; align-self: flex-end; }
.message.admin { background: #4b5563; color: white; align-self: flex-start; }
#chat-input-area { display: flex; padding: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
#chat-input { flex-grow: 1; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px; color: white; }
#send-chat-btn { background: #0ea5e9; color: white; border: none; padding: 0 12px; border-radius: 6px; margin-left: 8px; cursor: pointer; font-weight: bold; }

/* ANÄ°MASÄ°YA ÃœÃ‡ÃœN STÄ°LLÆR */
#preloader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--bg1);
  z-index: 10001;
  transition: opacity 1s ease-in-out;
}
#animated-bag {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: clamp(5rem,18vw,12rem);
  z-index: 10002;
  opacity: 0;
  filter: drop-shadow(0 8px 15px rgba(0,0,0,0.35));
}
.content-wrapper {
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
}
const firebaseConfig = { apiKey: "AIzaSyC4sGTK_P4KperVswrxxmt69H5cocsgnNw", authDomain: "niceuc-e5986.firebaseapp.com", databaseURL: "https://niceuc-e5986-default-rtdb.firebaseio.com", projectId: "niceuc-e5986", appId: "1:242221260650:web:d140153a2167c4738dcf13" };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
let balanceListener = null, chatStateListener = null, messageListener = null;

auth.onAuthStateChanged(user => {
    const supportWidget = document.getElementById('support-widget');
    if (user) {
        document.getElementById('userInfo').textContent = `Salam, ${user.displayName}`;
        db.ref('users/' + user.uid).set({ displayName: user.displayName, email: user.email });
        
        if (balanceListener) balanceListener.off();

        balanceListener = db.ref('balances/' + user.uid).on('value', snapshot => {
            const balanceData = snapshot.val();
            let newBalance = (balanceData && typeof balanceData.amount === 'number') ? balanceData.amount : 0;
            document.getElementById('balance').textContent = newBalance.toFixed(2);
        });

        supportWidget.style.display = 'block';
        initializeSupportChat(user);
    } else {
        document.getElementById('userInfo').textContent = '';
        document.getElementById('balance').textContent = '0.00';
        if (balanceListener) balanceListener.off();
        if (chatStateListener) chatStateListener.off();
        if (messageListener) messageListener.off();
        supportWidget.style.display = 'none';
    }
});

document.getElementById('loginBtn').addEventListener('click', () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(error => alert(error.message)); });
document.getElementById('payBtn').addEventListener('click', () => document.getElementById('payModal').style.display = 'flex');
document.getElementById('cekBtn').addEventListener('click', () => document.getElementById('cekModal').style.display = 'flex');
document.getElementById('pulCekBtn').addEventListener('click', () => document.getElementById('pulCekModal').style.display = 'flex');
document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modalOverlay').style.display = 'none'));
document.getElementById('sendCekBtn').addEventListener('click', () => { window.open(`https://wa.me/+994513239857?text=${encodeURIComponent('Ã‡EKÄ° GÃ–NDÆRÄ°RÆM')}`, '_blank'); document.getElementById('cekModal').style.display = 'none'; });

document.getElementById('notification-bell').addEventListener('click', () => {
    const user = auth.currentUser; if (!user) return alert('TarixÃ§É™yÉ™ baxmaq Ã¼Ã§Ã¼n daxil olun.');
    const modal = document.getElementById('notificationsModal'), list = document.getElementById('notifications-list');
    modal.style.display = 'flex'; document.getElementById('notification-badge').style.display = 'none';
    list.innerHTML = '<p>YÃ¼klÉ™nir...</p>';
    db.ref('withdrawals').orderByChild('uid').equalTo(user.uid).limitToLast(20).once('value', snapshot => {
        if (!snapshot.exists()) { list.innerHTML = '<p>HeÃ§ bir É™mÉ™liyyat tapÄ±lmadÄ±.</p>'; return; }
        list.innerHTML = ''; let items = []; snapshot.forEach(child => items.push(child.val()));
        items.reverse().forEach(data => {
            const itemDiv = document.createElement('div'), reqData = data.requestData;
            let statusText, statusClass;
            switch (data.status) { case 'approved': statusText = 'OnaylandÄ±'; statusClass = 'status-approved'; break; case 'rejected': statusText = 'RÉ™dd edildi'; statusClass = 'status-rejected'; break; default: statusText = 'GÃ¶zlÉ™mÉ™dÉ™'; statusClass = 'status-pending'; }
            itemDiv.className = `notification-item ${statusClass}`;
            const maskedCardNumber = '**** ' + reqData.cardNumber.slice(-4);
            itemDiv.innerHTML = `<div class="notification-item-header"><span class="notification-item-amount">${parseFloat(reqData.amount).toFixed(2)} AZN</span><span class="notification-item-status">${statusText}</span></div><div class="notification-item-body">Kart: ${maskedCardNumber}</div><div class="notification-item-footer">${new Date(data.createdAt).toLocaleString()}</div>`;
            list.appendChild(itemDiv);
        });
    });
});

document.getElementById('withdrawBtn').addEventListener('click', () => {
    const user = auth.currentUser;
    if (!user) return alert('ZÉ™hmÉ™t olmasa, daxil olun.');
    
    let currentBalance = 0;
    db.ref('balances/' + user.uid).once('value', snapshot => {
        const balanceData = snapshot.val();
        currentBalance = (balanceData && typeof balanceData.amount === 'number') ? balanceData.amount : 0;

        const amount = parseFloat(document.getElementById('withdrawAmount').value);
        const name = document.getElementById('userName').value.trim();
        const surname = document.getElementById('userSurname').value.trim();
        const card = document.getElementById('cardNumber').value.trim();
        if (isNaN(amount) || amount <= 0 || !name || !surname || !card) return alert('BÃ¼tÃ¼n xanalarÄ± dÃ¼zgÃ¼n doldurun.');
        if (card.length !== 16 || isNaN(card)) return alert('Kart nÃ¶mrÉ™si 16 rÉ™qÉ™mdÉ™n ibarÉ™t olmalÄ±dÄ±r.');
        if (amount > currentBalance) return alert('BalansÄ±nÄ±zda kifayÉ™t qÉ™dÉ™r vÉ™sait yoxdur.');

        const balanceRef = db.ref('balances/' + user.uid);
        
        balanceRef.transaction(currentData => {
            let currentBal = (currentData && currentData.amount) ? currentData.amount : 0;
            if (amount > currentBal) { return; }
            return { amount: currentBal - amount };
        }, (error, committed, snapshot) => {
            if (error) {
                alert('ÆmÉ™liyyat zamanÄ± xÉ™ta baÅŸ verdi: ' + error.message);
            } else if (!committed) {
                alert('BalansÄ±nÄ±zda kifayÉ™t qÉ™dÉ™r vÉ™sait yoxdur (É™mÉ™liyyat lÉ™ÄŸv edildi).');
            } else {
                const request = { 
                    uid: user.uid, 
                    userEmail: user.email, 
                    requestData: { name, surname, cardNumber: card, amount }, 
                    status: 'pending', 
                    createdAt: firebase.database.ServerValue.TIMESTAMP 
                };
                db.ref('withdrawals').push(request).then(() => {
                    alert('SorÄŸunuz gÃ¶ndÉ™rildi. MÉ™blÉ™ÄŸ balansÄ±nÄ±zdan Ã§Ä±xÄ±ldÄ± vÉ™ admin tÉ™sdiqini gÃ¶zlÉ™yir.');
                    document.getElementById('notification-badge').style.display = 'flex';
                    document.getElementById('pulCekModal').style.display = 'none';
                    document.getElementById('withdrawAmount').value = '';
                    document.getElementById('userName').value = '';
                    document.getElementById('userSurname').value = '';
                    document.getElementById('cardNumber').value = '';
                }).catch(err => {
                    alert('SorÄŸu yaradÄ±larkÉ™n xÉ™ta baÅŸ verdi, mÉ™blÉ™ÄŸ balansÄ±nÄ±za geri qaytarÄ±lÄ±r: ' + err.message);
                    balanceRef.transaction(currentData => {
                        let currentBal = (currentData && currentData.amount) ? currentData.amount : 0;
                        return { amount: currentBal + amount };
                    });
                });
            }
        });
    });
});

function initializeSupportChat(user) {
    const chatWindow = document.getElementById('chat-window'), chatToggleBtn = document.getElementById('chat-toggle-btn'), chatMessages = document.getElementById('chat-messages'), chatInput = document.getElementById('chat-input'), sendChatBtn = document.getElementById('send-chat-btn'), chatBadge = document.getElementById('chat-notification-badge');
    if (messageListener) messageListener.off(); if (chatStateListener) chatStateListener.off();
    chatToggleBtn.onclick = () => { const isHidden = chatWindow.style.display === 'none' || chatWindow.style.display === ''; chatWindow.style.display = isHidden ? 'flex' : 'none'; if (isHidden) { db.ref(`support_chats/${user.uid}/new_message_for_user_count`).set(0); } };
    const chatRef = db.ref(`support_chats/${user.uid}`);
    chatStateListener = chatRef.on('value', (snapshot) => { const count = snapshot.val()?.new_message_for_user_count || 0; chatBadge.textContent = count; chatBadge.style.display = count > 0 ? 'flex' : 'none'; });
    chatMessages.innerHTML = '';
    const messagesRef = db.ref(`support_chats/${user.uid}/messages`).limitToLast(50);
    messageListener = messagesRef.on('child_added', (snapshot) => { const message = snapshot.val(), messageDiv = document.createElement('div'); messageDiv.className = `message ${message.sender === 'admin' ? 'admin' : 'user'}`; messageDiv.textContent = message.text; chatMessages.appendChild(messageDiv); chatMessages.scrollTop = chatMessages.scrollHeight; });
    const sendMessage = () => {
        const text = chatInput.value.trim(); if (text === '') return;
        const messageData = { text: text, sender: user.uid, timestamp: firebase.database.ServerValue.TIMESTAMP };
        db.ref(`support_chats/${user.uid}/messages`).push(messageData);
        db.ref(`support_chats/${user.uid}`).update({ user_email: user.email, last_message: text, last_updated: firebase.database.ServerValue.TIMESTAMP, new_message_for_admin: true });
        chatInput.value = '';
    };
    sendChatBtn.onclick = sendMessage;
    chatInput.onkeydown = (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } };
}

// ANÄ°MASÄ°YA MÆNTÄ°QÄ°
window.onload = function() {
    const preloader = document.getElementById('preloader');
    const animatedBag = document.getElementById('animated-bag');
    const finalBag = document.querySelector('.card .bag');
    const contentWrapper = document.querySelector('.content-wrapper');

    // 1. PÉ™rdÉ™nin yavaÅŸca yox olmasÄ±
    preloader.style.opacity = '0';
    
    // 2. PÉ™rdÉ™ yox olmaÄŸa baÅŸlayarkÉ™n, mÉ™rkÉ™zdÉ™ki kisÉ™ peyda olur
    setTimeout(() => {
        animatedBag.style.opacity = '1';
        animatedBag.style.transition = 'all 1.2s cubic-bezier(0.68, -0.6, 0.32, 1.6)';
    }, 200);

    // 3. KisÉ™nin Ã¶z yerinÉ™ hÉ™rÉ™kÉ™ti
    setTimeout(() => {
        const finalBagRect = finalBag.getBoundingClientRect();
        animatedBag.style.left = `${finalBagRect.left + finalBagRect.width / 2}px`;
        animatedBag.style.top = `${finalBagRect.top + finalBagRect.height / 2}px`;
        animatedBag.style.fontSize = getComputedStyle(finalBag).fontSize;
    }, 1000);

    // 4. Animasiya bitdikdÉ™n sonra tÉ™mizlik iÅŸlÉ™ri
    setTimeout(() => {
        preloader.style.display = 'none';
        animatedBag.style.display = 'none';
        contentWrapper.style.opacity = '1';
        contentWrapper.style.visibility = 'visible';
    }, 2200);
};
          
