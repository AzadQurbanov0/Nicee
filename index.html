   <!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Para Çuvalı</title>
<style>
:root{
  --bg1:#0f0c29; --bg2:#302b63; --bg3:#24243e; --card:rgba(255,255,255,0.06);
  --glass:rgba(255,255,255,0.12); --text:#f8fafc; --accent:#22c55e; --red:#dc2626;
}
*{box-sizing:border-box;margin:0;padding:0;}
html{height:100%;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji';
  color:var(--text); background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  min-height: 100vh; overflow-y: auto; padding-top: 70px; padding-bottom: 70px;
}
.wrap{display:grid;place-items:center;gap:12px;text-align:center;padding:20px;}
.user-info{font-size:1rem;font-weight:600;opacity:.9;margin-bottom:6px;}
.card{
  position:relative; width:min(60vw,320px); aspect-ratio:1/1; display:grid; place-items:center;
  background: radial-gradient(60% 60% at 50% 30%,var(--glass),transparent 70%),var(--card);
  border:1px solid rgba(255,255,255,0.14); border-radius:24px;
  box-shadow:0 15px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.08);
  backdrop-filter:blur(6px);
}
.bag{font-size:clamp(5rem,18vw,12rem);filter:drop-shadow(0 8px 15px rgba(0,0,0,0.35));user-select:none;animation:float 5s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
.balance{margin-top:10px;display:grid;place-items:center;font-weight:700;letter-spacing:1px;text-shadow:0 2px 5px rgba(0,0,0,0.5);}
.balance .symbol{font-size:clamp(1rem,2.5vw,1.5rem);opacity:.9;margin-right:4px;}
.balance .value{font-size:clamp(1.5rem,5vw,2.5rem);line-height:1;}
.google-btn{ margin-top:14px; padding:8px 16px; font-size:0.95rem; background:#4285F4; color:white; border:none; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:600;}
.action-buttons button { position: fixed; right: 20px; padding: 8px 14px; font-size: 0.9rem; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; z-index: 1000; }
#payBtn { top: 20px; background: #22c55e; }
#cekBtn { top: 68px; background: #2563eb; }
#pulCekBtn { top: 116px; background: #f59e0b; }
#notification-bell { position: fixed; top: 20px; left: 20px; font-size: 28px; cursor: pointer; user-select: none; z-index: 10000; }
#notification-badge { position: absolute; top: -5px; right: -8px; background: #ef4444; color: white; width: 20px; height: 20px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
.modalOverlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:9999; display:none; }
.modalContent{ background:linear-gradient(135deg,var(--bg1),var(--bg2)); padding:20px; border-radius:12px; text-align:center; color:white; width: min(90vw, 350px); max-height: 90vh; display: flex; flex-direction: column; }
.modalContent input { display: block; width: 95%; margin: 10px auto; padding: 10px; border-radius: 5px; border: 1px solid rgba(255, 255, 255, 0.2); background: #FFFFFF; color: #212529; font-size: 1rem; }
.modalContent button { margin-top:12px; padding:8px 16px; font-size:1rem; border:none; border-radius:8px; cursor:pointer; }
#announcements-container { margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
.announcement-item { background: rgba(14, 165, 233, 0.1); border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 6px; text-align: left; margin-bottom: 10px; }
.announcement-text { font-size: 0.9rem; margin: 0; white-space: pre-wrap; word-break: break-word; }
.announcement-meta { font-size: 0.75rem; opacity: 0.7; margin-top: 8px; text-align: right; }
#notifications-list { max-height: 350px; overflow-y: auto; text-align: left; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 8px; }
.notification-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9rem; border-left: 4px solid #555; }
.notification-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.notification-item-amount { font-size: 1.1rem; font-weight: bold; }
.notification-item-amount.positive { color: #22c55e; } .notification-item-amount.negative { color: #fca5a5; }
.notification-item-status { font-weight: bold; padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.8rem;}
.notification-item-body { font-size: 0.85rem; opacity: 0.8; display: flex; justify-content: space-between; align-items: center; }
.notification-item-footer { font-size: 0.75rem; opacity: 0.7; margin-top: 8px; text-align: right; }
.status-pending { border-left-color: #f59e0b; } .status-pending .notification-item-status { background-color: #f59e0b; }
.status-approved { border-left-color: #16a34a; } .status-approved .notification-item-status { background-color: #16a34a; }
.status-rejected { border-left-color: #dc2626; } .status-rejected .notification-item-status { background-color: #dc2626; }
.status-cancelled { border-left-color: #6b7280; } .status-cancelled .notification-item-status { background-color: #6b7280; }
.status-deposit { border-left-color: #3b82f6; } .status-deposit .notification-item-status { background-color: #3b82f6; }
.cancel-btn { background: var(--red); color: white; border: none; padding: 4px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
#support-widget { position: fixed; bottom: 80px; right: 20px; z-index: 10000; }
#chat-toggle-btn { background: #0ea5e9; color: white; width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); position: relative; }
#chat-notification-badge { position: absolute; top: 0px; right: 0px; background: #ef4444; color: white; min-width: 22px; height: 22px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; padding: 2px; }
#chat-window { position: absolute; bottom: 80px; right: 0; width: 320px; max-width: 90vw; height: 400px; background: var(--bg3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; display: none; flex-direction: column; overflow: hidden; }
#chat-header { padding: 10px; background: rgba(0,0,0,0.2); font-weight: bold; text-align: center; }
#chat-messages { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
.message { max-width: 80%; padding: 8px 12px; border-radius: 10px; line-height: 1.4; word-break: break-word; }
.message.user { background: #2563eb; color: white; align-self: flex-end; }
.message.admin { background: #4b5563; color: white; align-self: flex-start; }
#chat-input-area { display: flex; padding: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
#chat-input { flex-grow: 1; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px; color: white; }
#send-chat-btn { background: #0ea5e9; color: white; border: none; padding: 0 12px; border-radius: 6px; margin-left: 8px; cursor: pointer; font-weight: bold; }
#preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg1); z-index: 10001; transition: opacity 1s ease-in-out; }
#animated-bag { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: clamp(5rem,18vw,12rem); z-index: 10002; opacity: 0; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.35)); }
.content-wrapper { display:flex; flex-direction:column; flex-grow:1; opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out; width:100%;}
.balance-update-text { animation: text-flash 0.7s ease-in-out; }
@keyframes text-flash { 0% { color: var(--text); transform: scale(1); } 50% { color: var(--accent); transform: scale(1.2); text-shadow: 0 0 10px var(--accent); } 100% { color: var(--text); transform: scale(1); } }
.coin { position: fixed; top: -50px; font-size: 2rem; z-index: 9998; pointer-events: none; animation-name: fall-and-fade; animation-timing-function: cubic-bezier(0.55, 0.085, 0.68, 0.53); animation-fill-mode: forwards; }
@keyframes fall-and-fade { from { transform: translateY(0) rotateZ(0deg); opacity: 1; } to { transform: translateY(65vh) rotateZ(360deg); opacity: 0; } }
.filter-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
.filter-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--text); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: background 0.2s ease; }
.filter-btn:hover { background: rgba(255,255,255,0.2); }
.filter-btn.active { background: var(--accent); color: var(--bg1); font-weight: bold; border-color: var(--accent); }
#status-icon { position: fixed; top: 20px; left: 60px; font-size: 28px; cursor: pointer; user-select: none; z-index: 10000; }
#status-list { text-align: left; display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
.status-item { display: flex; align-items: center; gap: 12px; }
.status-indicator { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
.status-indicator.active { background-color: var(--accent); }
.status-indicator.delayed { background-color: #f59e0b; }
.status-indicator.paused { background-color: var(--red); }
.status-text .label { font-weight: bold; display: block; margin-bottom: 4px; }
.status-text .description { font-size: 0.9rem; opacity: 0.8; }
#countdown-banner {
  display: none; position: fixed; top: 20px; right: 20px; transform: translateX(120%);
  background: rgba(15, 12, 41, 0.8); backdrop-filter: blur(5px); color: #f59e0b;
  padding: 12px 20px; border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.3);
  z-index: 10005; font-weight: 600; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  width: auto; transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
}
#countdown-banner.visible { transform: translateX(0); }
.falling-coin {
  position: fixed; top: -60px; font-size: 2.2rem; user-select: none;
  pointer-events: auto; cursor: pointer; z-index: 10003;
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); padding: 5px;
}
@keyframes fall-animation {
  from { transform: translateY(0) rotateZ(0deg); opacity: 1; }
  to { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
}
.page-list ul { list-style: none; padding: 0; width: 100%; text-align: left; margin-top: 15px; max-height: 400px; overflow-y: auto; }
.page-list li { background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; font-size: 1rem; font-weight: 500; display: flex; justify-content: space-between; align-items: center; }
.page-list li:first-child { background: #f59e0b; color: var(--bg1); font-weight: bold; }
#game-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10002; display: none; }
footer { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 5px 0; z-index: 1001; border-top: 1px solid rgba(255,255,255,0.1); }
.nav-item { color: var(--text); text-decoration: none; text-align: center; font-size: 0.75rem; padding: 8px 12px; border-radius: 8px; transition: background 0.2s ease; cursor:pointer;}
.nav-item span { font-size: 1.5rem; display: block; }
.nav-item.active { background: rgba(255,255,255,0.2); font-weight: bold; }
.page { display: none; width: 100%; max-width: 500px; padding: 15px; animation: fadeIn 0.5s ease; }
.page.active { display: block; }
#main-page.active { display: flex; flex-grow: 1; align-items: center; justify-content: center; }
.page-header { font-size: 1.8rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
.accordion {
    background-color: rgba(255,255,255,0.08); color: var(--text); cursor: pointer;
    padding: 18px; width: 100%; border: none; text-align: left; outline: none;
    font-size: 1rem; font-weight: 600; transition: background-color 0.3s ease;
    border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
}
.accordion:after { content: '\\2795'; font-size: 13px; color: #777; }
.accordion.active:after { content: "\\2796"; }
.accordion:hover, .accordion.active { background-color: rgba(255,255,255,0.15); }
.panel {
    padding: 0 18px; background-color: transparent; max-height: 0;
    overflow: hidden; transition: max-height 0.3s ease-out; margin-bottom: 10px;
}
.panel p { margin: 15px 0; line-height: 1.6; opacity: 0.9; }
 /* ================== BİRJA SƏHİFƏSİ STİLLƏRİ ================== */
.birja-card { width: 100%; aspect-ratio: auto; padding: 20px; margin-bottom: 15px; }
.coin-price { font-size: 1.5rem; font-weight: 700; color: var(--accent); text-align: center; }
.birja-balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
.birja-balance-grid span { font-size: 0.9rem; opacity: 0.8; }
.birja-balance-grid p { font-size: 1.2rem; font-weight: bold; margin: 5px 0 0; }
.trade-panel .tabs { display: flex; border-bottom: 2px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
.trade-panel .tab { padding: 10px 20px; cursor: pointer; font-size: 1.1rem; font-weight: bold; color: rgba(255,255,255,0.6); }
.trade-panel .tab.active { color: var(--text); border-bottom: 2px solid var(--accent); }
.trade-panel .form-group label { display: block; margin-bottom: 8px; opacity: 0.8; }
.trade-panel .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white; font-size: 1rem; }
.trade-panel .summary { margin-top: 15px; padding: 12px; background-color: rgba(0,0,0,0.3); border-radius: 8px; text-align: center; font-weight: 600; }
.trade-panel .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
.trade-panel .btn-buy { background-color: var(--accent); color: var(--bg1); }
.trade-panel .btn-sell { background-color: var(--red); color: white; }

/* ================== YENİ TARİXÇƏ STİLLƏRİ ================== */
.history-list-container { max-height: 300px; overflow-y: auto; padding-right: 5px; }
.history-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); animation: slideIn 0.5s ease-out; }
@keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
.history-item:last-child { border-bottom: none; }
.history-indicator { font-size: 1.5rem; margin-right: 15px; font-weight: bold; }
.history-indicator.buy { color: var(--accent); }
.history-indicator.sell { color: var(--red); }
.history-details { flex-grow: 1; }
.history-details p { margin: 0; font-weight: 600; font-size: 1rem; }
.history-details .history-meta { font-size: 0.8rem; opacity: 0.7; margin-top: 4px; }
.history-amount { text-align: right; }
.history-amount p { margin: 0; font-weight: bold; font-size: 1rem; }
.history-amount .history-meta { font-size: 0.8rem; opacity: 0.7; margin-top: 4px; }
</style>
</head>
<body>
<div id="preloader"></div>
<div id="animated-bag">💰</div>
<div id="game-overlay"></div>

<div id="countdown-banner">Para Yağışı <span id="countdown-timer">30</span> saniyəyə başlayır!</div>

<div class="content-wrapper">
    <div id="notification-bell"><span>🔔</span><div id="notification-badge" style="display:none;">1</div></div>
    <div id="status-icon"><span>ℹ️</span></div>
    <div class="action-buttons"><button id="payBtn">💲 BALANSI ARTIR</button><button id="cekBtn">📷 ÇEK ŞƏKLİ</button><button id="pulCekBtn">🏦 PULU ÇIXART</button></div>

    <div id="main-page" class="page active">
        <main class="wrap">
            <div id="userInfo" class="user-info"></div>
            <div class="card">
                <div class="bag">💰</div>
                <div class="balance">
                    <span class="symbol">AZN</span>
                    <span id="balance" class="value">0.00</span>
                </div>
            </div>
            <button class="google-btn" id="loginBtn">🌐 Giriş</button>
        </main>
    </div>

    <div id="leaderboard-page" class="page">
        <h2 class="page-header">Para Yağışı Nəticələri</h2>
        <div id="leaderboard-list" class="page-list"><ul><li>Yüklənir...</li></ul></div>
    </div>

    <div id="stats-page" class="page">
        <h2 class="page-header">Statistika</h2>
        <div id="stats-list" class="page-list"><ul><li>Yüklənir...</li></ul></div>
    </div>

    <div id="help-page" class="page">
        <h2 class="page-header">Kömək</h2>
        <button class="accordion">"Para Çuvalı" nədir?</button>
        <div class="panel">
            <p>Bu, istifadəçilərin müxtəlif yollarla virtual balans artıra və "Para Yağışı" kimi oyunlarda iştirak edərək real mükafatlar qazana biləcəyi bir əyləncə platformasıdır.</p>
        </div>
        <button class="accordion">Balansı necə artırmaq olar?</button>
        <div class="panel">
            <p>Əsas səhifədəki "YÜKLƏ" düyməsini istifadə edərək təlimatlara əməl edə bilərsiniz.</p>
        </div>
        <button class="accordion">Pul çıxarmaq mümkündür?</button>
        <div class="panel">
            <p>Bəli, "ÇEK" düyməsini istifadə edərək bank kartınıza pul çıxarışı üçün sorğu göndərə bilərsiniz. Sorğular administrasiya tərəfindən yoxlanılır.</p>
        </div>
        <button class="accordion">"Para Yağışı" nədir?</button>
        <div class="panel">
            <p>Bu, təsadüfi zamanlarda başlayan bir oyundur. Ekrandan düşən ikonları tutaraq xal qazanırsınız. Oyun sonunda ən çox xal toplayanlar balanslarına real pul mükafatı əldə edirlər. Liderlər cədvəlindən nəticələrə baxa bilərsiniz.</p>
        </div>
    </div>
        <div id="birja-page" class="page">
        <h2 class="page-header" id="birjaCoinName">Coin Birjası</h2>
        
        <div class="card birja-card">
            <div class="coin-price" id="birjaCoinPrice">1 Coin = 0.00 AZN</div>
        </div>

        <div class="card birja-card">
            <div class="birja-balance-grid">
                <div>
                    <span>Pul Balansınız</span>
                    <p id="birjaAznBalance">0.00 AZN</p>
                </div>
                <div>
                    <span>Coin Balansınız</span>
                    <p id="birjaUserCoinBalance">0.00 Coin</p>
                </div>
            </div>
        </div>

        <div class="card birja-card trade-panel">
            <div class="tabs">
                <div class="tab active" id="buy-tab">Almaq</div>
                <div class="tab" id="sell-tab">Satmaq</div>
            </div>
            <div id="buy-form">
                <div class="form-group">
                    <label>Almaq istədiyiniz miqdar (Coin)</label>
                    <input type="number" id="buyAmount" placeholder="0.00" oninput="calculateBirjaTotal('buy')">
                </div>
                <div class="summary" id="buySummary">Yekun Məbləğ: 0.00 AZN</div><br>
                <button class="btn btn-buy" id="buyCoinBtn">ALMAQ</button>
            </div>
            <div id="sell-form" style="display:none;">
                <div class="form-group">
                    <label>Satmaq istədiyiniz miqdar (Coin)</label>
                    <input type="number" id="sellAmount" placeholder="0.00" oninput="calculateBirjaTotal('sell')">
                </div>
                <div class="summary" id="sellSummary">Əldə edəcəksiniz: 0.00 AZN</div><br>
                <button class="btn btn-sell" id="sellCoinBtn">SATMAQ</button>
            </div>
        </div>

        <div class="card birja-card">
            <h3 style="text-align: center; margin-bottom: 15px; opacity: 0.9;">Əməliyyat Tarixçəsi</h3>
            <div class="history-list-container" id="transaction-history-list">
                <p style="text-align:center; opacity:0.6;">Yüklənir...</p>
            </div>
        </div>
    </div>
 
    <div class="modalOverlay" id="payModal"><div class="modalContent"><p>💲 PUL YÜKLƏ M10 077 543 50 53</p><button class="close-modal-btn">Bağla</button></div></div>
    <div class="modalOverlay" id="cekModal"><div class="modalContent"><p>ÇƏKİN ŞƏKLİNİ GÖNDƏRMƏYƏ BAS</p><button id="sendCekBtn">GÖNDƏR</button><button class="close-modal-btn">Bağla</button></div></div>
    <div class="modalOverlay" id="pulCekModal"><div class="modalContent"><h3>Pul Çıxarma Sorğusu</h3><input type="number" id="withdrawAmount" placeholder="Məbləğ (AZN)" required><input type="text" id="userName" placeholder="Ad" required><input type="text" id="userSurname" placeholder="Soyad" required><input type="tel" id="cardNumber" placeholder="Kart nömrəsi (16 rəqəm)" maxlength="16" required><button id="withdrawBtn">💸 PUL ÇIXART</button><button class="close-modal-btn">Bağla</button></div></div>
    <div class="modalOverlay" id="notificationsModal"><div class="modalContent"><h3>Hesab Çıxarışı və Elanlar</h3><div class="filter-buttons"><button class="filter-btn" onclick="fetchAndDisplayHistory('7d')">Son 7 gün</button><button class="filter-btn" onclick="fetchAndDisplayHistory('month')">Bu Ay</button><button class="filter-btn active" onclick="fetchAndDisplayHistory('all')">Bütün Tarixçə</button></div><div id="announcements-container"></div><div id="notifications-list"></div><button class="close-modal-btn">Bağla</button></div></div>
    <div class="modalOverlay" id="statusModal"><div class="modalContent"><h3>Sistem Vəziyyəti</h3><div id="status-list"><p>Məlumatlar yüklənir...</p></div><button class="close-modal-btn">Bağla</button></div></div>
    <div class="modalOverlay" id="leaderboardResultModal"><div class="modalContent"><h3>Para Yağışı Nəticələri</h3><div id="leaderboard-result-list"></div><button class="close-modal-btn">Bağla</button></div></div>

    <div id="support-widget"><div id="chat-window"><div id="chat-header">Dəstək</div><div id="chat-messages"></div><div id="chat-input-area"><input type="text" id="chat-input" placeholder="Mesajınızı yazın..."><button id="send-chat-btn"> göndər</button></div></div><button id="chat-toggle-btn"><span>💬</span><div id="chat-notification-badge" style="display:none;"></div></button></div>
</div>

<footer>
    <a class="nav-item active" id="homeBtn"><span>🏠</span>Əsas</a>
    <a class="nav-item" id="leaderboardBtn"><span>🏅</span>Liderlər</a>
    <a class="nav-item" id="statsBtn"><span>📊</span>Statistika</a>
    <a class="nav-item" id="birjaBtn"><span>📈</span>Birja</a>
    <a class="nav-item" id="helpBtn"><span>❓</span>Kömək</a>
</footer>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyC4sGTK_P4KperVswrxxmt69H5cocsgnNw", authDomain: "niceuc-e5986.firebaseapp.com", databaseURL: "https://niceuc-e5986-default-rtdb.firebaseio.com", projectId: "niceuc-e5986", appId: "1:242221260650:web:d140153a2167c4738dcf13" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let balanceListener = null, chatStateListener = null, messageListener = null, birjaSettingsListener = null, userCoinBalanceListener = null;
    function animateCountUp(element, start, end, duration) { let startTime = null; const step = (timestamp) => { if (!startTime) startTime = timestamp; const progress = Math.min((timestamp - startTime) / duration, 1); const current = start + progress * (end - start); element.textContent = current.toFixed(2); if (progress < 1) { window.requestAnimationFrame(step); } }; window.requestAnimationFrame(step); }
    function createCoinShower() { const coinCount = 10; const body = document.body; for (let i = 0; i < coinCount; i++) { const coin = document.createElement('span'); coin.className = 'coin'; coin.innerHTML = '🪙'; coin.style.left = `${Math.random() * 95}vw`; coin.style.animationDuration = `${Math.random() * 0.8 + 0.6}s`; coin.style.animationDelay = `${Math.random() * 0.4}s`; body.appendChild(coin); setTimeout(() => { coin.remove(); }, 2000); } }
    
    auth.onAuthStateChanged(user => {
        const supportWidget = document.getElementById('support-widget');
        let lastKnownBalance = 0;
        if (user) {
            document.getElementById('userInfo').textContent = `Salam, ${user.displayName}`;
            document.getElementById('loginBtn').style.display = 'none';
            db.ref('users/' + user.uid).update({ displayName: user.displayName, email: user.email });
            if (balanceListener) balanceListener.off();
            balanceListener = db.ref('balances/' + user.uid).on('value', snapshot => {
                const balanceData = snapshot.val();
                let newBalance = (balanceData && typeof balanceData.amount === 'number') ? balanceData.amount : 0;
                const balanceElement = document.getElementById('balance');
                if (newBalance > lastKnownBalance && lastKnownBalance !== 0) {
                    createCoinShower();
                    balanceElement.classList.add('balance-update-text');
                    balanceElement.addEventListener('animationend', () => { balanceElement.classList.remove('balance-update-text'); }, { once: true });
                    animateCountUp(balanceElement, lastKnownBalance, newBalance, 1200);
                } else {
                    balanceElement.textContent = newBalance.toFixed(2);
                }
                lastKnownBalance = newBalance;
            });
            supportWidget.style.display = 'block';
            initializeSupportChat(user);
            initializeSystemStatus();
            listenForMoneyRain();
        } else {
            document.getElementById('userInfo').textContent = 'Xoş Gəlmisiniz!';
            document.getElementById('loginBtn').style.display = 'flex';
            document.getElementById('balance').textContent = '0.00';
            lastKnownBalance = 0;
            if (balanceListener) balanceListener.off();
            if (chatStateListener) chatStateListener.off();
            if (messageListener) messageListener.off();
            if (birjaSettingsListener) birjaSettingsListener.off();
            if (userCoinBalanceListener) userCoinBalanceListener.off();
            supportWidget.style.display = 'none';
        }
    });

    // ================== BİRJA FUNKSİYALARI (YENİLƏNMİŞ) ==================
    let currentCoinData = { price: 0, name: 'Coin' };
    let currentUserCoinBalance = 0;
    let currentUserAznBalance = 0;

    function initializeBirja() {
        const user = auth.currentUser;
        if (!user) {
            alert("Birjaya baxmaq üçün zəhmət olmasa, daxil olun.");
            switchPage('main-page');
            return;
        }

        if (birjaSettingsListener) birjaSettingsListener.off();
        birjaSettingsListener = db.ref('birja_settings').on('value', snapshot => {
            if (snapshot.exists()) {
                currentCoinData = snapshot.val();
                document.getElementById('birjaCoinName').textContent = currentCoinData.name || 'Coin Birjası';
                document.getElementById('birjaCoinPrice').textContent = `1 ${currentCoinData.name || 'Coin'} = ${parseFloat(currentCoinData.price || 0).toFixed(2)} AZN`;
            }
        });

        db.ref('balances/' + user.uid).on('value', snapshot => {
             const balanceData = snapshot.val();
             currentUserAznBalance = (balanceData && typeof balanceData.amount === 'number') ? balanceData.amount : 0;
             document.getElementById('birjaAznBalance').textContent = `${currentUserAznBalance.toFixed(2)} AZN`;
        });
        
        if (userCoinBalanceListener) userCoinBalanceListener.off();
        userCoinBalanceListener = db.ref('user_coins/' + user.uid).on('value', snapshot => {
            const coinData = snapshot.val();
            currentUserCoinBalance = (coinData && typeof coinData.amount === 'number') ? coinData.amount : 0;
            document.getElementById('birjaUserCoinBalance').textContent = `${currentUserCoinBalance.toFixed(2)} ${currentCoinData.name || 'Coin'}`;
        });
        
        loadTransactionHistory(user.uid); // YENİ: Tarixçəni yükləyən funksiya
    }

    // YENİ: TARİXÇƏ YÜKLƏMƏ FUNKSİYASI
    function loadTransactionHistory(uid) {
        const historyList = document.getElementById('transaction-history-list');
        const historyRef = db.ref(`birja_transactions/${uid}`).orderByChild('timestamp').limitToLast(20);

        historyRef.on('value', snapshot => {
            historyList.innerHTML = '';
            if (!snapshot.exists()) {
                historyList.innerHTML = '<p style="text-align:center; opacity:0.6;">Heç bir əməliyyat tapılmadı.</p>';
                return;
            }
            
            let transactions = [];
            snapshot.forEach(child => {
                transactions.push(child.val());
            });
            transactions.reverse(); // Ən yenini yuxarıda göstər

            transactions.forEach(tx => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                
                const isBuy = tx.type === 'buy';
                const indicator = isBuy ? '▲' : '▼';
                const indicatorClass = isBuy ? 'buy' : 'sell';
                const actionText = isBuy ? 'Alındı' : 'Satıldı';
                
                itemDiv.innerHTML = `
                    <div class="history-indicator ${indicatorClass}">${indicator}</div>
                    <div class="history-details">
                        <p>${tx.amountCoin.toFixed(2)} ${currentCoinData.name || 'Coin'} ${actionText}</p>
                        <div class="history-meta">${new Date(tx.timestamp).toLocaleString()}</div>
                    </div>
                    <div class="history-amount">
                        <p>${tx.amountAzn.toFixed(2)} AZN</p>
                        <div class="history-meta">@ ${tx.pricePerCoin.toFixed(2)}</div>
                    </div>
                `;
                historyList.appendChild(itemDiv);
            });
        });
    }
    
    document.getElementById('buy-tab').addEventListener('click', () => {
        document.getElementById('buy-form').style.display = 'block';
        document.getElementById('sell-form').style.display = 'none';
        document.getElementById('buy-tab').classList.add('active');
        document.getElementById('sell-tab').classList.remove('active');
    });

    document.getElementById('sell-tab').addEventListener('click', () => {
        document.getElementById('buy-form').style.display = 'none';
        document.getElementById('sell-form').style.display = 'block';
        document.getElementById('sell-tab').classList.add('active');
        document.getElementById('buy-tab').classList.remove('active');
    });

    function calculateBirjaTotal(type) {
        const price = parseFloat(currentCoinData.price) || 0;
        if (type === 'buy') {
            const amount = parseFloat(document.getElementById('buyAmount').value) || 0;
            const total = (amount * price).toFixed(2);
            document.getElementById('buySummary').innerText = `Yekun Məbləğ: ${total} AZN`;
        } else {
            const amount = parseFloat(document.getElementById('sellAmount').value) || 0;
            const total = (amount * price).toFixed(2);
            document.getElementById('sellSummary').innerText = `Əldə edəcəksiniz: ${total} AZN`;
        }
    }
    
    document.getElementById('buyCoinBtn').addEventListener('click', () => {
        const user = auth.currentUser;
        if (!user) return alert('Zəhmət olmasa, daxil olun.');
        const amountToBuy = parseFloat(document.getElementById('buyAmount').value);
        if (isNaN(amountToBuy) || amountToBuy <= 0) return alert('Düzgün miqdar daxil edin.');
        const cost = amountToBuy * currentCoinData.price;
        if (cost > currentUserAznBalance) return alert('AZN balansınızda kifayət qədər vəsait yoxdur.');

        const newTransactionKey = db.ref().child('birja_transactions').push().key;
        const transactionData = {
            type: 'buy', amountCoin: amountToBuy, amountAzn: cost,
            pricePerCoin: currentCoinData.price, timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        const updates = {};
        updates[`/balances/${user.uid}/amount`] = firebase.database.ServerValue.increment(-cost);
        updates[`/user_coins/${user.uid}/amount`] = firebase.database.ServerValue.increment(amountToBuy);
        updates[`/birja_transactions/${user.uid}/${newTransactionKey}`] = transactionData;
        
        db.ref().update(updates)
            .then(() => {
                alert(`${amountToBuy.toFixed(2)} ${currentCoinData.name} uğurla alındı!`);
                document.getElementById('buyAmount').value = '';
                calculateBirjaTotal('buy');
            })
            .catch(error => alert('Xəta baş verdi: ' + error.message));
    });

    document.getElementById('sellCoinBtn').addEventListener('click', () => {
        const user = auth.currentUser;
        if (!user) return alert('Zəhmət olmasa, daxil olun.');
        const amountToSell = parseFloat(document.getElementById('sellAmount').value);
        if (isNaN(amountToSell) || amountToSell <= 0) return alert('Düzgün miqdar daxil edin.');
        if (amountToSell > currentUserCoinBalance) return alert(`${currentCoinData.name} balansınızda kifayət qədər vəsait yoxdur.`);
        const earnings = amountToSell * currentCoinData.price;

        const newTransactionKey = db.ref().child('birja_transactions').push().key;
        const transactionData = {
            type: 'sell', amountCoin: amountToSell, amountAzn: earnings,
            pricePerCoin: currentCoinData.price, timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        const updates = {};
        updates[`/balances/${user.uid}/amount`] = firebase.database.ServerValue.increment(earnings);
        updates[`/user_coins/${user.uid}/amount`] = firebase.database.ServerValue.increment(-amountToSell);
        updates[`/birja_transactions/${user.uid}/${newTransactionKey}`] = transactionData;

        db.ref().update(updates)
            .then(() => {
                alert(`${amountToSell.toFixed(2)} ${currentCoinData.name} uğurla satıldı! Balansınıza ${earnings.toFixed(2)} AZN əlavə edildi.`);
                document.getElementById('sellAmount').value = '';
                calculateBirjaTotal('sell');
            })
            .catch(error => alert('Xəta baş verdi: ' + error.message));
    });
    
    document.getElementById('birjaBtn').addEventListener('click', () => switchPage('birja-page'));
    // ================== BİRJA FUNKSİYALARI SON ==================
     function cancelWithdrawal(withdrawalId, amount) { const parsedAmount = parseFloat(amount); if (!confirm(`${parsedAmount.toFixed(2)} AZN məbləğindəki çıxarış sorğusunu ləğv etmək istədiyinizə əminsiniz? Məbləğ balansınıza geri qaytarılacaq.`)) { return; } const user = auth.currentUser; if (!user) return alert("Xəta: İstifadəçi tapılmadı."); const withdrawalRef = db.ref(`withdrawals/${withdrawalId}`); withdrawalRef.once('value').then(snapshot => { const request = snapshot.val(); if (!request || request.status !== 'pending') { alert("Bu sorğu artıq emal edilib və ləğv edilə bilməz."); document.getElementById('notification-bell').click(); return; } const updates = {}; updates[`/withdrawals/${withdrawalId}/status`] = 'cancelled'; updates[`/balances/${user.uid}/amount`] = firebase.database.ServerValue.increment(parsedAmount); db.ref().update(updates).then(() => { alert("Sorğunuz ləğv edildi və məbləğ balansınıza geri qaytarıldı."); const modal = document.getElementById('notificationsModal'); if (modal.style.display === 'flex') { modal.style.display = 'none'; setTimeout(() => document.getElementById('notification-bell').click(), 200); } }).catch(error => { alert("Xəta baş verdi: " + error.message); }); }); }
    document.getElementById('loginBtn').addEventListener('click', () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(error => alert(error.message)); });
    document.getElementById('payBtn').addEventListener('click', () => document.getElementById('payModal').style.display = 'flex');
    document.getElementById('cekBtn').addEventListener('click', () => document.getElementById('cekModal').style.display = 'flex');
    document.getElementById('pulCekBtn').addEventListener('click', () => document.getElementById('pulCekModal').style.display = 'flex');
    document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modalOverlay').style.display = 'none'));
    document.getElementById('sendCekBtn').addEventListener('click', () => { window.open(`https://wa.me/+994513239857?text=${encodeURIComponent('ÇEKİ GÖNDƏRİRƏM')}`, '_blank'); document.getElementById('cekModal').style.display = 'none'; });
    let fetchAndDisplayHistory;
    document.getElementById('notification-bell').addEventListener('click', () => { const user = auth.currentUser; if (!user) return alert('Tarixçəyə baxmaq üçün daxil olun.'); const modal = document.getElementById('notificationsModal'); const list = document.getElementById('notifications-list'); const announcementsContainer = document.getElementById('announcements-container'); modal.style.display = 'flex'; document.getElementById('notification-badge').style.display = 'none'; announcementsContainer.innerHTML = ''; const announcementsRef = db.ref('announcements').limitToLast(5).once('value'); announcementsRef.then(announcementsSnapshot => { if (announcementsSnapshot.exists()) { let announcements = []; announcementsSnapshot.forEach(child => { announcements.push(child.val()); }); announcements.reverse().forEach(ann => { const annDiv = document.createElement('div'); annDiv.className = 'announcement-item'; annDiv.innerHTML = `<p class="announcement-text">${ann.text}</p><div class="announcement-meta">${new Date(ann.createdAt).toLocaleDateString()}</div>`; announcementsContainer.appendChild(annDiv); }); } }); fetchAndDisplayHistory = function(filterType = 'all') { list.innerHTML = '<p>Yüklənir...</p>'; document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); const activeButton = [...document.querySelectorAll('.filter-btn')].find(btn => btn.getAttribute('onclick').includes(`'${filterType}'`)); if (activeButton) activeButton.classList.add('active'); let startTime = 0; const now = new Date(); if (filterType === '7d') { startTime = now.setDate(now.getDate() - 7); } else if (filterType === 'month') { startTime = new Date(now.getFullYear(), now.getMonth(), 1).getTime(); } const withdrawalsRef = db.ref('withdrawals').orderByChild('uid').equalTo(user.uid).once('value'); const depositsRef = db.ref('deposits').orderByChild('uid').equalTo(user.uid).once('value'); Promise.all([withdrawalsRef, depositsRef]).then(([withdrawalsSnapshot, depositsSnapshot]) => { let allTransactions = []; withdrawalsSnapshot.forEach(child => { allTransactions.push({ key: child.key, ...child.val() }); }); depositsSnapshot.forEach(child => { allTransactions.push({ ...child.val(), type: 'deposit' }); }); const filteredTransactions = allTransactions.filter(item => item.createdAt >= startTime); if (filteredTransactions.length === 0) { list.innerHTML = '<p>Bu dövr üçün heç bir əməliyyat tapılmadı.</p>'; return; } filteredTransactions.sort((a, b) => b.createdAt - a.createdAt); list.innerHTML = ''; filteredTransactions.forEach(data => { const itemDiv = document.createElement('div'); if (data.type === 'deposit') { const descriptionText = data.description || 'Balansınıza vəsait əlavə edildi.'; itemDiv.className = 'notification-item status-deposit'; itemDiv.innerHTML = `<div class="notification-item-header"><span class="notification-item-amount positive">+${parseFloat(data.amount).toFixed(2)} AZN</span><span class="notification-item-status">Mədaxil</span></div><div class="notification-item-body"><span>${descriptionText}</span></div><div class="notification-item-footer">${new Date(data.createdAt).toLocaleString()}</div>`; } else { const reqData = data.requestData; let statusText, statusClass; switch (data.status) { case 'approved': statusText = 'Onaylandı'; statusClass = 'status-approved'; break; case 'rejected': statusText = 'Rədd edildi'; statusClass = 'status-rejected'; break; case 'pending': statusText = 'Gözləmədə'; statusClass = 'status-pending'; break; case 'cancelled': statusText = 'Ləğv Edildi'; statusClass = 'status-cancelled'; break; default: statusText = data.status; statusClass = 'status-cancelled'; } let actionHtml = ''; if (data.status === 'pending') { actionHtml = `<button class="cancel-btn" onclick="cancelWithdrawal('${data.key}', ${reqData.amount})">Ləğv Et</button>`; } itemDiv.className = `notification-item ${statusClass}`; const maskedCardNumber = reqData.cardNumber ? '**** ' + reqData.cardNumber.slice(-4) : 'Kart məlumatı yoxdur'; itemDiv.innerHTML = `<div class="notification-item-header"><span class="notification-item-amount negative">-${parseFloat(reqData.amount).toFixed(2)} AZN</span><span class="notification-item-status">${statusText}</span></div><div class="notification-item-body"><span>Kart: ${maskedCardNumber}</span> ${actionHtml}</div><div class="notification-item-footer">${new Date(data.createdAt).toLocaleString()}</div>`; } list.appendChild(itemDiv); }); }).catch(error => { list.innerHTML = '<p>Məlumatları yükləyərkən xəta baş verdi.</p>'; console.error("Error fetching data:", error); }); }; fetchAndDisplayHistory('all'); });
    document.getElementById('withdrawBtn').addEventListener('click', () => { const user = auth.currentUser; if (!user) return alert('Zəhmət olmasa, daxil olun.'); let currentBalance = 0; db.ref('balances/' + user.uid).once('value', snapshot => { const balanceData = snapshot.val(); currentBalance = (balanceData && typeof balanceData.amount === 'number') ? balanceData.amount : 0; const amount = parseFloat(document.getElementById('withdrawAmount').value); const name = document.getElementById('userName').value.trim(); const surname = document.getElementById('userSurname').value.trim(); const card = document.getElementById('cardNumber').value.trim(); if (isNaN(amount) || amount <= 0 || !name || !surname || !card) return alert('Bütün xanaları düzgün doldurun.'); if (card.length !== 16 || isNaN(card)) return alert('Kart nömrəsi 16 rəqəmdən ibarət olmalıdır.'); if (amount > currentBalance) return alert('Balansınızda kifayət qədər vəsait yoxdur.'); const balanceRef = db.ref('balances/' + user.uid); balanceRef.transaction(currentData => { let currentBal = (currentData && currentData.amount) ? currentData.amount : 0; if (amount > currentBal) { return; } return { amount: currentBal - amount }; }, (error, committed, snapshot) => { if (error) { alert('Əməliyyat zamanı xəta baş verdi: ' + error.message); } else if (!committed) { alert('Balansınızda kifayət qədər vəsait yoxdur (əməliyyat ləğv edildi).'); } else { const request = { uid: user.uid, userEmail: user.email, requestData: { name, surname, cardNumber: card, amount }, status: 'pending', createdAt: firebase.database.ServerValue.TIMESTAMP }; db.ref('withdrawals').push(request).then(() => { alert('Sorğunuz göndərildi. Məbləğ balansınızdan çıxıldı və admin təsdiqini gözləyir.'); document.getElementById('notification-badge').style.display = 'flex'; document.getElementById('pulCekModal').style.display = 'none'; ['withdrawAmount', 'userName', 'userSurname', 'cardNumber'].forEach(id => document.getElementById(id).value = ''); }).catch(err => { alert('Sorğu yaradılarkən xəta baş verdi, məbləğ balansınıza geri qaytarılır: ' + err.message); balanceRef.transaction(currentData => ({ amount: ((currentData && currentData.amount) || 0) + amount })); }); } }); }); });
    function initializeSupportChat(user) { const chatWindow = document.getElementById('chat-window'), chatToggleBtn = document.getElementById('chat-toggle-btn'), chatMessages = document.getElementById('chat-messages'), chatInput = document.getElementById('chat-input'), sendChatBtn = document.getElementById('send-chat-btn'), chatBadge = document.getElementById('chat-notification-badge'); if (messageListener) messageListener.off(); if (chatStateListener) chatStateListener.off(); chatToggleBtn.onclick = () => { const isHidden = chatWindow.style.display === 'none' || chatWindow.style.display === ''; chatWindow.style.display = isHidden ? 'flex' : 'none'; if (isHidden) { db.ref(`support_chats/${user.uid}/new_message_for_user_count`).set(0); } }; const chatRef = db.ref(`support_chats/${user.uid}`); chatStateListener = chatRef.on('value', (snapshot) => { const count = snapshot.val()?.new_message_for_user_count || 0; chatBadge.textContent = count; chatBadge.style.display = count > 0 ? 'flex' : 'none'; }); chatMessages.innerHTML = ''; const messagesRef = db.ref(`support_chats/${user.uid}/messages`).limitToLast(50); messageListener = messagesRef.on('child_added', (snapshot) => { const message = snapshot.val(), messageDiv = document.createElement('div'); messageDiv.className = `message ${message.sender === 'admin' ? 'admin' : 'user'}`; messageDiv.textContent = message.text; chatMessages.appendChild(messageDiv); chatMessages.scrollTop = chatMessages.scrollHeight; }); const sendMessage = () => { const text = chatInput.value.trim(); if (text === '') return; const messageData = { text: text, sender: user.uid, timestamp: firebase.database.ServerValue.TIMESTAMP }; db.ref(`support_chats/${user.uid}/messages`).push(messageData); db.ref(`support_chats/${user.uid}`).update({ user_email: user.email, last_message: text, last_updated: firebase.database.ServerValue.TIMESTAMP, new_message_for_admin: true }); chatInput.value = ''; }; sendChatBtn.onclick = sendMessage; chatInput.onkeydown = (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } }; }
     document.getElementById('status-icon').addEventListener('click', () => { document.getElementById('statusModal').style.display = 'flex'; });
    function initializeSystemStatus() { const statusRef = db.ref('system_status'); const statusListContainer = document.getElementById('status-list'); statusRef.on('value', (snapshot) => { if (!snapshot.exists()) { statusListContainer.innerHTML = '<p>Sistem vəziyyəti haqqında məlumat yoxdur.</p>'; return; } const statuses = snapshot.val(); statusListContainer.innerHTML = ''; const sortedStatuses = Object.values(statuses).sort((a, b) => a.order - b.order); sortedStatuses.forEach(data => { const itemDiv = document.createElement('div'); itemDiv.className = 'status-item'; itemDiv.innerHTML = ` <div class="status-indicator ${data.state || 'paused'}"></div> <div class="status-text"> <span class="label">${data.label}</span> <span class="description">${data.status_text}</span> </div> `; statusListContainer.appendChild(itemDiv); }); }); }
    window.onload = function() { const preloader = document.getElementById('preloader'); const animatedBag = document.getElementById('animated-bag'); const finalBag = document.querySelector('#main-page .card .bag'); const contentWrapper = document.querySelector('.content-wrapper'); preloader.style.opacity = '0'; setTimeout(() => { animatedBag.style.opacity = '1'; animatedBag.style.transition = 'all 1.2s cubic-bezier(0.68, -0.6, 0.32, 1.6)'; }, 200); setTimeout(() => { const finalBagRect = finalBag.getBoundingClientRect(); animatedBag.style.left = `${finalBagRect.left + finalBagRect.width / 2}px`; animatedBag.style.top = `${finalBagRect.top + finalBagRect.height / 2}px`; animatedBag.style.fontSize = getComputedStyle(finalBag).fontSize; }, 1000); setTimeout(() => { preloader.style.display = 'none'; animatedBag.style.display = 'none'; contentWrapper.style.opacity = '1'; contentWrapper.style.visibility = 'visible'; }, 2200); };
    let countdownInterval; let rainTimeout; let currentRainInterval = 500; let currentRainSpeed = 3.5;
    function listenForMoneyRain() { const moneyRainRef = db.ref('moneyRainEvent'); moneyRainRef.on('value', (snapshot) => { const event = snapshot.val(); if (!event) return; switch (event.status) { case 'pending': showCountdown(event.startTime); break; case 'active': hideCountdown(); startRainAnimation(event.duration); break; case 'finished': hideRainAnimation(); hideCountdown(); showLeaderboardResult(event.leaderboard); break; default: hideRainAnimation(); hideCountdown(); break; } }); }
    function showCountdown(startTime) { const banner = document.getElementById('countdown-banner'); const timerEl = document.getElementById('countdown-timer'); banner.style.display = 'block'; setTimeout(() => banner.classList.add('visible'), 50); clearInterval(countdownInterval); countdownInterval = setInterval(() => { const remaining = Math.max(0, Math.round((startTime - Date.now()) / 1000)); timerEl.textContent = remaining; if (remaining <= 0) { clearInterval(countdownInterval); } }, 1000); }
    function hideCountdown() { const banner = document.getElementById('countdown-banner'); banner.classList.remove('visible'); clearInterval(countdownInterval); }
    function startRainAnimation(duration) { if (rainTimeout) clearTimeout(rainTimeout); document.getElementById('game-overlay').style.display = 'block'; currentRainInterval = 500; currentRainSpeed = 3.5; function gameLoop() { createFallingCoin(); rainTimeout = setTimeout(gameLoop, currentRainInterval); } gameLoop(); }
    function hideRainAnimation() { document.getElementById('game-overlay').style.display = 'none'; clearTimeout(rainTimeout); rainTimeout = null; document.querySelectorAll('.falling-coin').forEach(c => c.remove()); }
    function createFallingCoin() { const coin = document.createElement('div'); coin.className = 'falling-coin'; coin.textContent = ['🪙', '💰', '💵', '💎'][Math.floor(Math.random() * 4)]; coin.style.left = `${Math.random() * 95}vw`; coin.style.animation = `fall-animation ${Math.random() * 1 + currentRainSpeed}s linear forwards`; coin.onclick = (event) => collectCoin(event.currentTarget); document.body.appendChild(coin); setTimeout(() => coin.remove(), (currentRainSpeed + 1.5) * 1000); }
    function collectCoin(coinElement) { const user = auth.currentUser; if (!user || !coinElement) return; coinElement.remove(); currentRainSpeed = Math.max(1.5, currentRainSpeed - 0.05); currentRainInterval = Math.max(100, currentRainInterval - 5); const userScoreRef = db.ref(`moneyRainEvent/participants/${user.uid}`); userScoreRef.transaction((data) => { if (data === null) { return { score: 1, displayName: user.displayName }; } else { return { ...data, score: (data.score || 0) + 1 }; } }); }
    function showLeaderboardResult(leaderboardData) { if (!leaderboardData) return; const modal = document.getElementById('leaderboardResultModal'); const listContainer = document.getElementById('leaderboard-result-list'); const sortedPlayers = Object.values(leaderboardData).sort((a, b) => b.reward - a.reward); let leaderboardHtml = '<ul>'; if (sortedPlayers.length > 0) { sortedPlayers.slice(0, 20).forEach((player, index) => { leaderboardHtml += `<li>#${index + 1} <b>${player.displayName}</b> - ${player.reward.toFixed(2)} AZN qazandı!</li>`; }); } else { leaderboardHtml += '<li>Heç kim iştirak etmədi.</li>'; } leaderboardHtml += '</ul>'; listContainer.innerHTML = leaderboardHtml; modal.style.display = 'flex'; }
    function switchPage(pageId) { const actionButtons = document.querySelector('.action-buttons'); const notificationBell = document.getElementById('notification-bell'); const statusIcon = document.getElementById('status-icon'); document.querySelectorAll('.page').forEach(page => page.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active')); document.getElementById(pageId).classList.add('active'); if (pageId === 'main-page') { actionButtons.style.display = 'block'; notificationBell.style.display = 'block'; statusIcon.style.display = 'block'; } else { actionButtons.style.display = 'none'; notificationBell.style.display = 'none'; statusIcon.style.display = 'none'; } switch (pageId) { case 'main-page': document.getElementById('homeBtn').classList.add('active'); break; case 'leaderboard-page': document.getElementById('leaderboardBtn').classList.add('active'); fetchLeaderboard(); break; case 'stats-page': document.getElementById('statsBtn').classList.add('active'); fetchStatistics(); break; case 'birja-page': document.getElementById('birjaBtn').classList.add('active'); initializeBirja(); break; case 'help-page': document.getElementById('helpBtn').classList.add('active'); break; } }
    document.getElementById('homeBtn').addEventListener('click', () => switchPage('main-page'));
    document.getElementById('leaderboardBtn').addEventListener('click', () => switchPage('leaderboard-page'));
    document.getElementById('statsBtn').addEventListener('click', () => switchPage('stats-page'));
    document.getElementById('helpBtn').addEventListener('click', () => switchPage('help-page'));
    function fetchLeaderboard() { const listContainer = document.getElementById('leaderboard-list'); listContainer.innerHTML = "<ul><li>Yüklənir...</li></ul>"; const moneyRainRef = db.ref('moneyRainEvent/leaderboard'); moneyRainRef.once('value', (snapshot) => { if(snapshot.exists()) { const leaderboardData = snapshot.val(); const sortedPlayers = Object.values(leaderboardData).sort((a, b) => b.reward - a.reward); let leaderboardHtml = '<ul>'; if (sortedPlayers.length > 0) { sortedPlayers.slice(0, 20).forEach((player, index) => { leaderboardHtml += `<li>#${index + 1} <b>${player.displayName}</b> - ${player.reward.toFixed(2)} AZN qazandı!</li>`; }); } else { leaderboardHtml += '<li>Heç kim iştirak etmədi.</li>'; } leaderboardHtml += '</ul>'; listContainer.innerHTML = leaderboardHtml; } else { listContainer.innerHTML = "<ul><li>Hələ heç bir nəticə yoxdur.</li></ul>"; } }); }
    function maskDisplayName(name) { if (!name || name.length < 3) return "***"; const start = name.slice(0, 2); const end = name.slice(-1); const middle = '*'.repeat(Math.max(3, name.length - 3)); return `${start}${middle}${end}`; }
    function fetchStatistics() { const statsList = document.getElementById('stats-list'); statsList.innerHTML = "<ul><li>Yüklənir...</li></ul>"; const balancesRef = db.ref('balances').orderByChild('amount').limitToLast(25); const usersRef = db.ref('users'); Promise.all([balancesRef.once('value'), usersRef.once('value')]).then(([balancesSnapshot, usersSnapshot]) => { if (!balancesSnapshot.exists()) { statsList.innerHTML = "<ul><li>Statistika məlumatı tapılmadı.</li></ul>"; return; } const allUsers = usersSnapshot.val() || {}; let statsData = []; balancesSnapshot.forEach(childSnapshot => { const uid = childSnapshot.key; const balanceData = childSnapshot.val(); const userData = allUsers[uid]; if (userData && balanceData.amount > 0) { statsData.push({ displayName: userData.displayName || "Naməlum", amount: balanceData.amount }); } }); statsData.sort((a, b) => b.amount - a.amount); if (statsData.length === 0) { statsList.innerHTML = "<ul><li>Statistika məlumatı tapılmadı.</li></ul>"; return; } let statsHtml = '<ul>'; statsData.forEach((player, index) => { const maskedName = maskDisplayName(player.displayName); statsHtml += `<li>#${index + 1} <b>${maskedName}</b> <span>${player.amount.toFixed(2)} AZN</span></li>`; }); statsHtml += '</ul>'; statsList.innerHTML = statsHtml; }).catch(error => { console.error("Statistika yüklənərkən xəta:", error); statsList.innerHTML = "<ul><li>Məlumatları yükləmək mümkün olmadı.</li></ul>"; }); }
    const accordions = document.getElementsByClassName("accordion");
    for (let i = 0; i < accordions.length; i++) { accordions[i].addEventListener("click", function() { this.classList.toggle("active"); const panel = this.nextElementSibling; if (panel.style.maxHeight) { panel.style.maxHeight = null; } else { panel.style.maxHeight = panel.scrollHeight + "px"; } }); }
</script>
</body>
</html>
