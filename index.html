<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Panel - Gizli</title>
<style>
body{margin:0;padding:20px;font-family:system-ui;background:#1e1e2f;color:#f8fafc;}
h1{margin-bottom:20px;text-align:center;}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border:1px solid rgba(255,255,255,0.2);text-align:center;}
th{background:rgba(255,255,255,0.1);}
button{padding:5px 10px;margin:2px;border:none;border-radius:4px;cursor:pointer;}
button.add{background:#22c55e;color:white;}
button.sub{background:#f87171;color:white;}
button.apply{background:#3b82f6;color:white;}
input[type=number]{width:60px;text-align:center;border-radius:4px;border:none;}
</style>
</head>
<body>
<h1>Admin Panel - Gizli</h1>
<table id="userTable">
<thead>
<tr><th>Ad</th><th>Email</th><th>Balans</th><th>Əməliyyat</th></tr>
</thead>
<tbody></tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC4sGTK_P4KperVswrxxmt69H5cocsgnNw",
  authDomain: "niceuc-e5986.firebaseapp.com",
  databaseURL: "https://niceuc-e5986-default-rtdb.firebaseio.com",
  projectId: "niceuc-e5986",
  storageBucket: "niceuc-e5986.firebasestorage.app",
  messagingSenderId: "242221260650",
  appId: "1:242221260650:web:d140153a2167c4738dcf13",
  measurementId: "G-YKKRHJKYNB"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const userTableBody = document.getElementById('userTable').querySelector('tbody');

// DOM elementlərini saxlayırıq ki flash olmasın
const userRows = {};

function loadUsers(){
  const usersRef = db.ref('users');
  usersRef.get().then(snapshot => {
    snapshot.forEach(child => {
      const uid = child.key;
      const data = child.val();
      const balanceRef = db.ref('balances/' + uid);

      balanceRef.get().then(bsnap=>{
        const balance = bsnap.val() || 0;

        // Əgər row yoxdursa yarat
        if(!userRows[uid]){
          const tr = document.createElement('tr');
          tr.id = 'row-'+uid;
          tr.innerHTML=`
            <td>${data.name}</td>
            <td>${data.email}</td>
            <td id="bal-${uid}">${parseFloat(balance).toFixed(2)}</td>
            <td>
              <button class="add" onclick="adjustBalance('${uid}',1)">+1</button>
              <button class="sub" onclick="adjustBalance('${uid}',-1)">-1</button><br>
              <input type="number" id="input-${uid}" value="0">
              <button class="apply" onclick="changeBalance('${uid}')">Tətbiq et</button>
            </td>
          `;
          userTableBody.appendChild(tr);
          userRows[uid] = tr;
        } else {
          // Əgər row varsa sadəcə balansı yenilə
          const balTd = document.getElementById('bal-'+uid);
          balTd.textContent = parseFloat(balance).toFixed(2);
        }
      });
    });
  });
}

function adjustBalance(uid,amount){
  const balanceRef=db.ref('balances/'+uid);
  balanceRef.transaction(current=>(current||0)+amount);
}

function changeBalance(uid){
  const input=document.getElementById('input-'+uid);
  const val=parseFloat(input.value);
  if(isNaN(val)) return;
  const balanceRef=db.ref('balances/'+uid);
  balanceRef.transaction(current=>(current||0)+val);
  input.value=0;
}

// İlk yükləmə
loadUsers();

// Hər 1 saniyədə yeniləmə
setInterval(loadUsers,1000);
</script>
</body>
</html>
